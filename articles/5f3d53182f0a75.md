---
title: "WSL2ã¨Arch Linuxã€systemdã‚’æ·»ãˆã¦ 2023/12"
emoji: "ğŸªŸ"
type: "tech"
topics:
  - "wsl2"
  - "systemd"
  - "archlinux"
published: true
published_at: "2023-12-24 23:47"
---

ã“ã®è¨˜äº‹ã¯[ğŸ…GMOãƒšãƒ‘ãƒœã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ Advent Calendar 2023 - Adventar](https://adventar.org/calendars/8634) 22æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

WSL2ã§SystemdãŒå‹•ãã‚ˆã†ã«ãªã£ã¦ä¹…ã—ã„ã§ã™ã€‚ã—ã‹ã—ã€æ–°è¦ã«Arch Linuxã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸç’°å¢ƒ(n=2)ã§ã¯systemdãŒ`initialising`ã§æ­¢ã¾ã£ã¦ã—ã¾ã†äº‹è±¡ãŒãŠãã¾ã—ãŸã€‚ãã®è§£æ±ºã‚‚å«ã‚ã¦æ‰‹é †ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚

å‚è€ƒ:
- [Arch on WSLã‚’æ§‹ç¯‰ã™ã‚‹](https://zenn.dev/kyoh86/articles/4bf6513aabe517)
- [WSL 2 ã§ Arch Linux ã‚’ä½¿ã† - yukirii blog](https://blog.yukirii.dev/wsl2-arch-linux/)

WSLç­‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```
WSL ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.0.14.0
ã‚«ãƒ¼ãƒãƒ« ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 5.15.133.1-1
WSLg ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.59
MSRDC ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.2.4677
Direct3D ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.611.1-81528511
DXCore ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 10.0.25131.1002-220531-1700.rs-onecore-base2-hyp
Windows ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 10.0.22631.2861
```

## ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨å†åœ§ç¸®

WSLæ¨™æº–ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ãªã„ã‚‚ã®ã‚’ä½¿ã†ã«ã¯ã€`wsl --import`ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Arch LinuxãŒå…¬å¼ã«é…å¸ƒã—ã¦ã„ã‚‹ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€ãã®ã¾ã¾ã§ã¯importã§ããªã„ãŸã‚ä¸€æ‰‹é–“ã‹ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€WSLã®Ubuntuç­‰ã®ç’°å¢ƒãŒã‚ã‚‹ã¨ä¾¿åˆ©ãªã®ã§ã€`wsl --install`ç­‰ã§ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚

ã“ã“ã§ã‚„ã‚‹ã“ã¨ã¯2ã¤ã§ã™ã€‚

- `/etc/pacman.d/mirrorlist`ã‚’ç·¨é›†ã™ã‚‹
- ãƒ«ãƒ¼ãƒˆãŒ`/`ã«ãªã‚‹ã‚ˆã†ã«åœ§ç¸®ã—ãªãŠã™

### ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

https://www.archlinux.jp/download/ ã‹ã‚‰é©å½“ãªãƒŸãƒ©ãƒ¼ã‚’é¸æŠã—ã€tar.gzã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢(ISO)ã§ã¯ãªããƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹tar.gzãªã®ã§é–“é•ãˆãªã„ã‚ˆã†ã«ã€‚(archlinux-bootstrap-2023.12.01-x86_64.tar.gzã¨ã„ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«åã«ãªã£ã¦ã„ã‚‹ã‚‚ã®)

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰ã€é©å½“ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å±•é–‹ã—ã¾ã™ã€‚

```
$ wget https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2023.12.01/archlinux-bootstrap-2023.12.01-x86_64.tar.gz
.tar.zg
$ tar -zxvf archlinux-bootstrap-2023.12.01-x86_64.tar.gz
```

### pacmanã®mirrorlistã‚’å¤‰æ›´ã™ã‚‹

ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ãµã¤ã†ã®ã‚¨ãƒ‡ã‚£ã‚¿ãŒå…¥ã£ã¦ã„ãªã„ã®ã§ã€ã“ã®æ™‚ç‚¹ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹éš›ã«ä½¿ã†ãƒŸãƒ©ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãŠãã¨ã‚ˆã„ã§ã™ã€‚

```
$ vim root.x86_64/etc/pacman.d/mirrorlist #é©å½“ãªJapanã®ã‚µãƒ¼ãƒã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
```

ã“ã“ã§ã‚‚ã—å¿˜ã‚ŒãŸå ´åˆã¯ã€`wsl --import`å¾Œã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§ãƒªã‚«ãƒãƒªãƒ¼ãŒå¯èƒ½ã§ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒˆã«ã—ãªã„ã¨å¤‰æ•°ãŒå±•é–‹ã•ã‚Œã¦ç„¡ã«ãªã‚‹ã®ã§æ³¨æ„ã€‚

```
echo 'Server = https://mirrors.cat.net/archlinux/$repo/os/$arch' >> /etc/pacman.d/mirrorlist
```

### tar.gzã«å†åœ§ç¸®ã™ã‚‹

è§£ç­”ã™ã‚‹ã¨`root.x86+64`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã§ãã¦ã„ã‚‹ã®ã§ã€**ã“ã®ä¸­ã«å…¥ã£ã¦ã‹ã‚‰tar.gzã«åœ§ç¸®ã—ãªãŠã—ã¾ã™ã€‚**

ã“ã‚Œã«ã‚ˆã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã ã£ãŸã‚‚ã®ãŒ

- root.x86_64/
  - usr
  - bin
  - ...

æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- /
  - usr
  - bin
  - ...

ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®æ§‹é€ ã«ã™ã‚‹ã“ã¨ã§`wsl --import`ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
$ cd root.x86_64
$ tar -zcvf arch_bootstrap.tar.gz .
```

åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ããŸã‚‰ `/mnt/c/Users/your_name` ç­‰Windowsã‹ã‚‰è¦‹ãˆã‚‹ã¨ã“ã‚ã«ç§»å‹•ã•ã›ã¦ãŠãã¾ã™ã€‚

```
$ mv arch_bootstrap.tar.gz /mnt/c/Users/your_name/
```

## wsl --import

ä½œæˆã—ãŸãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’WSLã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ç¬¬ä¸€å¼•æ•°ã¯WSLã¸ã®ç™»éŒ²åã€ç¬¬äºŒå¼•æ•°ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆ(ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ç½®ãå ´æ‰€)ã€ç¬¬ä¸‰å¼•æ•°ã¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```
PS C:\Users\your_name> wsl --import arch C:\Users\your_name\wsl .\arch_bootstrap.tar.gz
```

ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒçµ‚ã‚ã£ãŸã‚‰`wsl -l`ã§ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```
PS C:\Users\your_name> wsl -l
Linux ç”¨ Windows ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³:
Ubuntu(æ—¢å®š)
arch
```

## systemdã‚’æœ‰åŠ¹ã«ã™ã‚‹

ä½œæˆã—ãŸç’°å¢ƒã«å…¥ã‚Šã€systemdã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚æœ€åˆã®çŠ¶æ…‹ã§ã¯æœ‰åŠ¹ã«ãªã£ã¦ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```
PS C:\Users\your_name> wsl -d arch
```

ã“ã“ã‹ã‚‰ã¯WSLå†…ã§ã™ã€‚systemdã¯ã¾ã èµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚

```
[root@DESKTOP ~]# systemctl status
System has not been booted with systemd as init system (PID 1). Can't operate.
Failed to connect to bus: Host is down
```

VMå†…ã®wsl.confã«systemdã‚’ä½¿ã†ãŸã‚ã®è¨­å®šã‚’ã—ã¾ã™ã€‚ã“ã‚Œã‚‚æœ€åˆã«ã‚„ã£ã¦ãŠã‘ã°ã‚ˆã‹ã£ãŸã§ã™ã­ã€‚

```
[root@DESKTOP ~]# echo -e "[boot]\nsystemd=true" > /etc/wsl.conf
```

PowerShellã«æˆ»ã‚Šã€WSLã‚’å†èµ·å‹•ã—ã¾ã™ã€‚

```
PS C:\Users\your_name> wsl --shutdown
```

## systemdãŒstartingã®ã¾ã¾ã«ãªã£ã¦ã„ã‚‹

WSLã‚’å†èµ·å‹•ã—ãŸã¨ã€`systemctl status`ã‚’ã¿ã‚‹ã¨`State`ãŒ`starting`ã®ã¾ã¾æ­¢ã¾ã£ã¦ã„ã¾ã™ã€‚

```
[root@Desktop wsl]# systemctl status
Failed to dump process list for 'Desktop', ignoring: Input/output error
â— Desktop
    State: starting
    Units: 283 loaded (incl. loaded aliases)
...
```

ã“ã®çŠ¶æ…‹ã§`journalctl -xb`ãªã©ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚‚ã€ç•°å¸¸ãªç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—æ•°åˆ†ã¾ã£ã¦ã‹ã‚‰å†åº¦statusã‚’è¦‹ã‚‹ã¨ã€ä»Šåº¦ã¯`degraded`ã¨ãªã‚Šå¤±æ•—ã—ã¦ã„ã‚‹unitãŒã‚ã‚‹ã“ã¨ã¯æ˜ã‚‰ã‹ã§ã™ã€‚

```
[root@Desktop wsl]# systemctl status
Failed to dump process list for 'Desktop', ignoring: Input/output error
â— Desktop
    State: degraded
    Units: 286 loaded (incl. loaded aliases)
     Jobs: 0 queued
   Failed: 1 units
```

å†åº¦`journalctl -xb`ç­‰ã§ãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨ã€`systemd-networkd-wait-online.service`ãŒå¤±æ•—ã—ã¦ã„ã‚‹ã“ã¨ã‚’ã¿ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚

```
systemd[1]: systemd-networkd-wait-online.service: Failed with result 'exit-code'
```

## åŸå› ã®systemd-networkdã¯disableã§ã‚ˆã„

`systemd-networkd-wait-online.service`ã¯`systemd-networkd`ã‹ã‚‰ã®ä¾å­˜ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã—ã‹ã—WSLã§å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹Ubuntuã§ã¯åŒã˜ã‚ˆã†ãªçŠ¶æ³ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã¨ãã«åˆ©ç”¨ã—ãŸUbuntuã‚’ã¿ã¦ã¿ã‚‹ã¨ã€Ubuntuã§ã¯`systemd-networkd`ãŒdisableã«ãªã£ã¦ã„ã¾ã™ã€‚

ãŸã—ã‹ã«ã€WSLã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯Windowså´ã§ã†ã¾ã„ã“ã¨ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§ã€`systemd-networkd`ã¯ä¸è¦ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã“ã¾ã§ã‚ã‹ã£ã¦ã‹ã‚‰issueã‚’ã—ã‚‰ã¹ã¦ã¿ã‚‹ã¨ã€`systemd-networkd-wait-online.service`ã«é–¢ã™ã‚‹å ±å‘Šã‚’ã„ãã¤ã‹ã¿ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚

ä¾‹:
[systemd-logind logs session out after few minutes](https://github.com/microsoft/WSL/issues/10552)

ã¨ã„ã†ã‚ã‘ã§ã€`systemd-networkd`ã‚’disableã«ã—ã¦ã€WSLã‚’å†èµ·å‹•ã—ã¾ã—ã‚‡ã†ã€‚

```
$ systemctl disable systemd-networkd
```

PowerShellã§`wsl --shutdown`ã‚’ã—ã¦ã‹ã‚‰ã€å†åº¦WSLã‚’é–‹ã`systemctl status`ã‚’å®Ÿè¡Œã™ã‚‹ã¨runningã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚ˆã‹ã£ãŸã§ã™ã­ã€‚

```
[root@Desktop wsl]# systemctl status
Failed to dump process list for 'Desktop', ignoring: Input/output error
â— Desktop
    State: running
    Units: 281 loaded (incl. loaded aliases)
     Jobs: 0 queued
   Failed: 0 units
```
